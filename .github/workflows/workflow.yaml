name: Test

on:
  # code pushed to pull request branch
  push:
    branches-ignore:
      - main
  # when draft state is removed (needed as automatically created PRs are not triggering this action)
  pull_request:
    types: [ready_for_review]

env:
  GITHUB_WORKFLOW: true
  COVERAGE_PYTHON_VERSION: 3.12
  COVERAGE_DJANGO_VERSION: 6.0
  COVERAGE_DATABASE: postgres

jobs:
  test:
    name: Test and coverage
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.14"
        django:
          - "4.2"
          - "5.2"
          - "6.0"
        database:
          - sqlite
          - mysql
          - postgres
        exclude:
          - django: "4.2"
            python-version: "3.13"
          - django: "4.2"
            python-version: "3.14"
          - django: "6.0"
            python-version: "3.10"
          - django: "6.0"
            python-version: "3.11"

    services:
      # postgres service
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      # mysql service
      mysql:
        image: mysql:9
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: test
          MYSQL_ROOT_PASSWORD: mysql
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Install mysql client
        if: matrix.database == "mysql"
        run: |
          sudo apt-get update
          sudo apt-get install -y default-mysql-client

      - name: Wait for MySQL to be ready
        if: matrix.database == "mysql"
        env:
          MYSQL_ROOT_PASSWORD: mysql
        run: |
          for i in $(seq 1 30); do
            mysql -h 127.0.0.1 -P 3306 -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1" && break
            echo "Waiting for mysql..."
            sleep 1
          done

      - name: Enable classic_hashing component (makes MD5 available)
        if: matrix.database == "mysql"
        env:
          MYSQL_ROOT_PASSWORD: mysql
        run: |
          mysql -h 127.0.0.1 -P 3306 -uroot -p${MYSQL_ROOT_PASSWORD} -e "INSTALL COMPONENT 'file://component_classic_hashing';"
          mysql -h 127.0.0.1 -P 3306 -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT MD5('test') as md5_test;"

      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7

      - name: Install requirements
        run: uv pip install --system -r requirements-ci.txt

      - name: Install Django ${{ matrix.django }}
        run: uv pip install --system "Django~=${{ matrix.django }}"
      - name: Install MySQL libs
        if: matrix.database == 'mysql'
        run: uv pip install --system mysqlclient>=2.2.7 django-mysql>=4.19.0
      - name: Install postgres libs
        if: matrix.database == 'postgres'
        run: uv pip install --system psycopg>=3.3.2

      - name: Install package
        run: uv pip install --system -e .

      - name: Run tests
        run: python manage.py test
        env:
          DATABASE_ENGINE: ${{ matrix.database }}

      - name: Coverage
        if: |
          matrix.python-version == env.COVERAGE_PYTHON_VERSION
          &&
          matrix.django == env.COVERAGE_DJANGO_VERSION
          &&
          matrix.database == env.COVERAGE_DATABASE
          &&
          github.repository == 'RegioHelden/django-scrubber'
          &&
          (
            github.event_name == 'push'
            ||
            (
              github.event_name == 'pull_request'
              &&
              github.head_ref == 'master'
            )
          )
        run: uv pip install --system coverage coveralls && coverage run --source=django_scrubber manage.py test && coveralls
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
          DATABASE_ENGINE: ${{ matrix.database }}
